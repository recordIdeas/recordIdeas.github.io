<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script type="text/javascript" src="../../js/xlsx.core.min.js"></script>
</head>
<body>
  <div class="condition">
    <button class="condition-del">-</button>
    <button class="condition-add">+</button>
    <div class="condition-model" hidden>
      <div class="condition-item">
        Make: <input class="condition-Make" type="text">
        Model: <input class="condition-Model" type="text">
        <button class="conditon-remove">x</button>
      </div>
    </div>
    <div class="condition-list">
      <div class="condition-item">
        Make: <input class="condition-Make" type="text">
        Model: <input class="condition-Model" type="text">
        <button class="conditon-remove">x</button>
      </div>
    </div>
    <script>
      document.querySelector(".condition-add").addEventListener("click",function(){
        document.querySelector(".condition-list").appendChild(document.querySelector(".condition-model .condition-item").cloneNode(true));
      });
      document.querySelector(".condition-del").addEventListener("click",function(){
        var node = document.querySelectorAll(".condition-item");
        if(node.length > 1) {
          document.querySelector(".condition-list").removeChild(node[node.length-1]);
        }
      });
      document.querySelector(".condition-list").addEventListener("click",function(e){
        var target = e.target;
        if(target.className === "conditon-remove") {
          document.querySelector(".condition-list").removeChild(target.parentNode);
        }
      });
    </script>
  </div>
  <input type="file" id="xFile" multiple name=""
  accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  onchange="showfile1(this,'excelFile', 60)" onclick="this.value=''" ;>
  <div id="excelFile">
    <table border='1'>
      <thead>
        <tr>
          <th>SKU</th>
          <th>Data</th>
          <th>product Details</th>
          <th>result</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <div class="export_btn" style="display: none;">导出excel:<input type="button" OnClick="btn_export('excelFile')" value="导出" /></div>
  <script>
    // 读取文件的内容
    function showfile1(obj, importExcel, maxNum) {
      var condition = [];
      document.querySelectorAll(".condition-item").forEach(function(e){
        if(handleStr(e.querySelector(".condition-Make").value) || handleStr(e.querySelector(".condition-Model").value)) {
          condition.push({
            Make: handleStr(e.querySelector(".condition-Make").value),
            Model: handleStr(e.querySelector(".condition-Model").value)
          });
        }
      });
      condition = unique(condition);

      document.getElementById(importExcel).nextElementSibling.style.display = "none";
      if (!obj.files) {
        return;
      }
      document.getElementById(importExcel).querySelector("tbody").innerHTML = "";

      var excelFile;
      for (var k = 0; k < obj.files.length; k++) {
        var f = obj.files[k];
        var reader = new FileReader();
        reader.filename = f.name;
        reader.readAsBinaryString(f);
        reader.onload = function (e) {
          var data = e.target.result;
          var name = e.target.filename;
          name = name.substring(0, name.lastIndexOf("."));
          excelFile = XLSX.read(data, {
            type: 'binary'
          });
          var headers = new Array();
          var str = XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[0]]);
          for (var key in str[0]) {
            headers.push(key)  //获取表头
          }
          var allStr = str;
          var allArr = finder(allStr);
          if(allArr.length > 0) {
            allArr = filter(allArr, condition);

            if(allArr.length > maxNum) {
              allArr.sort(sortCompare("Index"));
              allArr = allArr.splice(allArr.length - maxNum);
            }
            allArr.sort(sortLocaleCompare("Make","Model"));

            var finalArr = [];
            allArr.forEach(function(e){
              finalArr.push(e.Year + " " + e.Make + " " + e.Model);
            });

            allStr = finalArr.join(";<br>");
            document.getElementById(importExcel).querySelector("tbody").innerHTML += "<tr><td>"
            + name.replace(/\s/g,"").replace(/^0/,"0&nbsp;")
            + '</td><td contenteditable="true">' + allStr
            + '</td><td contenteditable="true"></td><td class="details-result" contenteditable="true"></td></tr>';
            document.getElementById(importExcel).nextElementSibling.style.display = "block";
          }
        }
      }
    }

    function finder(data) {
      var tree = {};
      data.forEach(function(e){
        if(!tree[e.Make]) {
          tree[e.Make] = {}
        }

        if(!tree[e.Make][e.Model]) {
          tree[e.Make][e.Model] = {}
        }

        if(!tree[e.Make][e.Model][e.Year]) {
          tree[e.Make][e.Model][e.Year] = handleStr(e.Year)
        }
      });

      var arr=[];
      for(var Make in tree) {
        var ModelTree = tree[Make];
        for(var Model in ModelTree) {
          var YearArr = [];
          var YearTree = ModelTree[Model];
          for(var Year in YearTree) {
            YearArr.push(Year);
          }
          YearArr.sort();

          var YearStr = "";
          YearArr.forEach(function(e, i) {
            if(i === 0) {
              YearStr = e;
            } else if(YearArr[i] - YearArr[i-1] === 1) {
              if(YearStr.substring(YearStr.lastIndexOf("-")).length === 5) {
                YearStr = YearStr.substring(0, YearStr.lastIndexOf("-")+1) + e;
              }else {
                YearStr += "-" + e;
              }
            } else {
              YearStr += "," + e;
            }
          });

          arr.push({
            Make: Make,
            Model: Model,
            Year: YearStr,
            Index: YearArr[YearArr.length -1]
          });
        }
      }

      return arr;
    }

    function filter(data, condition) {
      if(condition.length > 0) {
        var newData = [];
        var flag = false;
        condition.forEach(function(e) {
          data.forEach(function(f){
            if(e.Make != "" && e.Model != "") {
              if(f.Make === e.Make && f.Model === e.Model) {
                newData.push(f);
              }
            }else if(e.Make != "") {
              if(f.Make === e.Make) {
                newData.push(f);
              }
            }else if(e.Model != "") {
              if(f.Model === e.Model) {
                newData.push(f);
              }
            }
          })
        });
        return newData;
      }else {
        return data;
      }
    }

    function sortCompare(p) {
      return function(m,n) {
        var a = m[p];
        var b = n[p]
        return a - b;
      }
    }

    function sortLocaleCompare(p,q) {
      return function(m,n) {
        var a = m[p];
        var b = n[p];
        if(a === b) {
          var c = m[q];
          var d = n[q];
          return c.localeCompare(d, 'zh-CN', { numeric: true });
        }else {
          return a.localeCompare(b, 'zh-CN', { numeric: true });
        }
      }
    }

    function unique(arr){
     let result = {};
     let finalResult=[];
     arr.forEach(function(e){
      result[e.Make + e.Model] = e;
     });
     for(item in result){
      finalResult.push(result[item]);
     }
     return finalResult;
    }

    function handleStr(str) {
      return str.toString().trim().replace(/\s+/g,"");
    }
  </script>
</body>
</html>
