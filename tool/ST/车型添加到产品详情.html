<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>车型转换工具</title>
  <script type="text/javascript" src="../../js/xlsx.core.min.js"></script>
</head>
<body>
  <div class="tabs">
    <input type="radio" name="tabs" id="tabone" checked="checked">
    <label for="tabone">车型处理</label>
    <div class="tab">
      <div class="up_btn">导入车型表：
        <input type="file" id="xFile" multiple name=""
          accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          onchange="showfile1(this,'excelFile')" onclick="this.value=''" ;>
      </div>
      <div id="excelFile">
        <table border='1'>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Data</th>
              <th>product Details</th>
              <th>result</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="export_btn">导出excel:<input type="button" OnClick="btn_export('excelFile')" value="导出" /></div>
    </div>
    <input type="radio" name="tabs" id="tabtwo">
    <label for="tabtwo">批量处理</label>
    <div class="tab">
      <div class="up_btn">导入统计表：
        <input type="file" id="xFile" name=""
          accept="application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          onchange="showfile2(this,'totalExcel')" onclick="this.value=''" ;>
      </div>
      <div id="totalExcel">
        <table border='1'>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Data</th>
              <th>product Details</th>
              <th>result</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="export_btn">导出excel:<input type="button" OnClick="btn_export('totalExcel')" value="导出" /></div>
    </div>
  </div>

  <style>
    * {
      box-sizing: border-box;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    textarea {
      width: 100%;
      white-space: pre-line;
      padding: 0;
      border: 0;
      height: 1em;
    }

    .export_btn {
      display: none;
    }

    table {
      width: 100%;
    }

    td {
      vertical-align: baseline;
    }

    th:nth-of-type(1),
    td:nth-of-type(1) {
      width: 5%;
    }

    th:nth-of-type(2),
    td:nth-of-type(2) {
      width: 25%;
    }

    th:nth-of-type(3),
    td:nth-of-type(3),
    th:nth-of-type(4),
    td:nth-of-type(4) {
      width: 35%;
    }

    .tabs {
      padding: 10px;
    }

    .up_btn {
      padding-bottom: 10px;
    }

    .tabs input[name="tabs"] {
      display: none;
    }

    .tabs input[name="tabs"]+label+.tab {
      display: none;
    }

    .tabs input[name="tabs"]:checked+label+.tab {
      display: block;
    }

    .tabs input[name="tabs"]:checked+label {
      border-bottom: 2px solid #444;
      margin-bottom: 5px;
      padding-bottom: 5px;
    }

    .tabs input[name="tabs"]~label:last-of-type {
      margin-right: 0;
    }

    .tabs input[name="tabs"]~label {
      margin-right: 20px;
    }

    .tabs .tab {
      position: absolute;
      margin-top: 15px;
      padding-right: 40px;
      width: 100%;
    }
  </style>
  <script>
    document.body.addEventListener("click", function (e) {
      var e = e || window.event;
      var target = e.target;
      if (target.className.indexOf("details-result") != -1) {
        var str2 = target.previousElementSibling.innerText;
        handleDetails(target, str2);
      }
    });

    // 读取文件的内容
    function showfile1(obj, importExcel) {
      var excelFile;
      document.getElementById(importExcel).nextElementSibling.style.display = "";
      if (!obj.files) {
        return;
      }
      document.getElementById(importExcel).querySelector("tbody").innerHTML = "";
      for (var k = 0; k < obj.files.length; k++) {
        var f = obj.files[k];
        var reader = new FileReader();
        reader.readAsBinaryString(f);
        reader.onload = function (e) {
          var data = e.target.result;
          excelFile = XLSX.read(data, {
            type: 'binary'
          });
          var headers = new Array();
          var str = XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[0]]);
          for (var key in str[0]) {
            headers.push(key)  //获取表头
          }
          str.sort(function (a, b) {
            var reA = /[^a-zA-Z]/g;
            var reN = /[^0-9]/g;
            a.Make = a.Make.toString();
            b.Make = b.Make.toString();
            var aA = a.Make.replace(reA, "");
            var bA = b.Make.replace(reA, "");
            if (aA === bA) {
              var aN = parseInt(a.Make.replace(reN, ""), 10);
              var bN = parseInt(b.Make.replace(reN, ""), 10);
              return aN === bN ? 0 : aN > bN ? 1 : -1;
            } else {
              return aA > bA ? 1 : -1;
            }
          });
          str.sort(function (a, b) {
            var reA = /[^a-zA-Z]/g;
            var reN = /[^0-9]/g;
            a.Model = a.Model.toString();
            b.Model = b.Model.toString();
            var aA = a.Model.replace(reA, "");
            var bA = b.Model.replace(reA, "");
            if (aA === bA) {
              var aN = parseInt(a.Model.replace(reN, ""), 10);
              var bN = parseInt(b.Model.replace(reN, ""), 10);
              return aN === bN ? 0 : aN > bN ? 1 : -1;
            } else {
              return aA > bA ? 1 : -1;
            }
          });
          str.sort(function (a, b) {
            if (a.Make === b.Make) {
              if (a.Model === b.Model) {
                return a.Year - b.Year;
              }
            }
          });
          var allStr = str[0][headers[2]] + "," + str[0][headers[3]] + "," + str[0][headers[1]];
          for (var i = 1; i < str.length; i++) {
            if (str[i]) {
              if (str[i][headers[2]] == str[i - 1][headers[2]]) {
                if (str[i][headers[3]] == str[i - 1][headers[3]]) {
                  if (str[i][headers[1]] != str[i - 1][headers[1]]) {
                    if (str[i][headers[1]] - str[i - 1][headers[1]] == 1) {
                      if (allStr.substring(allStr.lastIndexOf("-")).length == 5) {
                        allStr = allStr.substring(0, allStr.lastIndexOf("-")+1) + str[i][headers[1]];
                      } else {
                        allStr += "-" + str[i][headers[1]];
                      }
                    } else {
                      allStr += "," + str[i][headers[1]];
                    }
                  }
                } else {
                  allStr += ";<br>" + str[i][headers[2]] + "," + str[i][headers[3]] + "," + str[i][headers[1]];
                }
              } else {
                allStr += ";<br>" + str[i][headers[2]] + "," + str[i][headers[3]] + "," + str[i][headers[1]];
              }
            }
          }
          var allArr = allStr.split(";<br>");
          if(allArr.length>60){
            var allBrr = [];
            var allCrr = [];
            allCrr = allArr;
            sortUpdateYear(str,60,1990,30);
            if(allArr.length<41){
              allArr = allCrr;
            }
            var len = allArr.length > 60 ? 60 : allArr.length;
            for (var n = 0; n < len; n++) {
              allBrr[n] = allArr[n];
            }
            for(var b = 0; b < allBrr.length; b++){
              for(var c=0; c < allCrr.length; c++){
                if(getMake(allBrr,b) == getMake(allCrr,c) && getModel(allBrr,b) == getModel(allCrr,c)){
                  allBrr[b] = allCrr[c];
                  break;
                }
              }
            }
            allArr = allBrr;
            yearAsBegin(allArr);
          }else{
            yearAsBegin(allArr);
          }

          allStr = allArr.join(";<br>");
          document.getElementById(importExcel).querySelector("tbody").innerHTML += "<tr><td>"
                + str[0][headers[0]].toString().replace(/\s/g,"").replace(/^0/,"0&nbsp;")
               + '</td><td contenteditable="true">' + allStr
              + '</td><td contenteditable="true"></td><td class="details-result" contenteditable="true"></td></tr>';

          function sortUpdateYear(str,maxLen,Year,num,flag) {
            if(num>0){
              num--;
              if(allArr.length != maxLen){
                if(allArr.length > maxLen){
                  if(!flag){
                    flag = "default";
                  }else if(flag == "default"){
                    flag = "del-1";
                  }else if(flag == "add-1"){
                    flag = "del-2";
                  }else if(flag == "add-2"){
                    return allArr;
                  }
                  Year++;
                }else{
                  if(!flag){
                    flag = "default";
                  }else if(flag == "default"){
                    flag = "add-1";
                  }else if(flag == "del-1"){
                    flag = "add-2";
                  }else if(flag == "del-2"){
                    return allArr;
                  }
                  Year--;
                }
                sortByYear(str,Year);
                sortUpdateYear(str,maxLen,Year,num,flag);
              }else{
                return allArr;
              }
            }else{
              return allArr;
            }
          }

          function sortByYear(str,Year) {
            allStr = str[0][headers[2]] + "," + str[0][headers[3]] + "," + str[0][headers[1]];
            for (var i = 1; i < str.length; i++) {
              if (str[i] && Number(str[i][headers[1]].toString())>Year) {
                if (str[i][headers[2]] == str[i - 1][headers[2]]) {
                  if (str[i][headers[3]] == str[i - 1][headers[3]]) {
                    if (str[i][headers[1]] != str[i - 1][headers[1]]) {
                      if (str[i][headers[1]] - str[i - 1][headers[1]] == 1) {
                        if (allStr.substring(allStr.lastIndexOf("-")).length == 5) {
                          allStr = allStr.substring(0, allStr.lastIndexOf("-")+1) + str[i][headers[1]];
                        } else {
                          allStr += "-" + str[i][headers[1]];
                        }
                      } else {
                        allStr += "," + str[i][headers[1]];
                      }
                    }
                  } else {
                    allStr += ";<br>" + str[i][headers[2]] + "," + str[i][headers[3]] + "," + str[i][headers[1]];
                  }
                } else {
                  allStr += ";<br>" + str[i][headers[2]] + "," + str[i][headers[3]] + "," + str[i][headers[1]];
                }
              }
            }
            allArr = allStr.split(";<br>");
          }
        }
      }
      document.getElementById(importExcel).nextElementSibling.style.display = "block";
    }

    function showfile2(obj, importExcel) {
      var excelFile;
      document.getElementById(importExcel).nextElementSibling.style.display = "";
      if (!obj.files) {
        return;
      }
      var f = obj.files[0];

      var reader = new FileReader();
      reader.readAsBinaryString(f);
      reader.onload = function (e) {
        var data = e.target.result;
        excelFile = XLSX.read(data, {
          type: 'binary'
        });

        var headers = new Array();
        var str = XLSX.utils.sheet_to_json(excelFile.Sheets[excelFile.SheetNames[0]]);
        for (var key in str[0]) {
          headers.push(key)  //获取表头
        }

        var dataTable2 = "";
        for (var i = 0; i < str.length; i++) {
          if (str[i]) {
            if(str[i][headers[0]]){
              dataTable2 += "<tr><td>" + str[i][headers[0]].toString().replace(/\s/g,"").replace(/^0/,"0&nbsp;") + '</td>';
            }else{
              dataTable2 += '<tr><td></td>';
            }
            if(str[i][headers[1]]){
              dataTable2 += '<td contenteditable="true">'
              + str[i][headers[1]].replace(/\n/g, "<br>") + '</td>';
            }else{
              dataTable2 += '<td contenteditable="true"></td>';
            }
            if(str[i][headers[2]]){
              dataTable2 += '<td contenteditable="true">' + str[i][headers[2]]
              + '</td><td class="details-result" contenteditable="true"></td></tr>';
            }else{
              dataTable2 += '<td contenteditable="true"></td><td class="details-result" contenteditable="true"></td></tr>';
            }
          }
        }
        document.getElementById(importExcel).querySelector("tbody").innerHTML = dataTable2;
        var importDetals = document.getElementById(importExcel).querySelectorAll("tbody .details-result");
        for (var k in importDetals) {
          var str2 = importDetals[k].previousElementSibling.innerHTML;
          handleDetails(importDetals[k], str2);
        }
      }
      document.getElementById(importExcel).nextElementSibling.style.display = "block";
    }

    function btn_export(importExcel) {
      var table = document.getElementById(importExcel).querySelector("table");
      var sheet = XLSX.utils.table_to_sheet(table); //将一个table对象转换成一个sheet对象
      var wb = sheet2blob(sheet);
      if ('ie' == getExplorer()) {
        window.navigator.msSaveOrOpenBlob(wb, 'excel.xlsx');
      }
      else {
        var oa = document.createElement('a');
        oa.href = URL.createObjectURL(wb);
        oa.download = 'excel.xlsx';
        document.body.appendChild(oa);
        oa.click();
        document.body.removeChild(oa);
      }
    }

    // 将一个sheet转成最终的excel文件的blob对象，然后利用URL.createObjectURL下载
    function sheet2blob(sheet, sheetName) {
      try {
        new Uint8Array([1, 2]).slice(0, 2);
      } catch (e) {
        console.log("[Uint8Array" + e.description + "]这里使用【Array.slice】。");
        //IE或有些浏览器不支持Uint8Array.slice()方法。改成使用Array.slice()方法
        Uint8Array.prototype.slice = Array.prototype.slice;
      }
      sheetName = sheetName || 'sheet1';
      var workbook = {
        SheetNames: [sheetName],
        Sheets: {}
      };
      workbook.Sheets[sheetName] = sheet;
      // 生成excel的配置项
      var wopts = {
        bookType: 'xlsx', // 要生成的文件类型
        bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
        type: 'binary'
      };
      var wbout = XLSX.write(workbook, wopts);
      var blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
      // 字符串转ArrayBuffer
      function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
      }
      return blob;
    }

    function getExplorer() {
      var explorer = window.navigator.userAgent;
      //ie
      if (explorer.indexOf("MSIE") >= 0) {
        return 'ie';
      }
      //Edge
      if (explorer.indexOf("Edge") >= 0) {
        return 'ie';
      }
      //Trident
      if (explorer.indexOf("Trident") >= 0) {
        return 'ie';
      }
      return '';
    }

    function yearAsBegin(allArr){
      for (var m = 0; m < allArr.length; m++) {
        if (allArr[m].trim().replace(/\s+/g, " ") != "") {
          var s1 = allArr[m].substr(0, allArr[m].indexOf(","));
          var s2 = allArr[m].substr(allArr[m].indexOf(",") + 1);
          var s3 = s2.substr(s2.indexOf(",") + 1);
          var s2 = s2.substr(0, s2.indexOf(",")).replace(/\s+/g, " ");
          allArr[m] = s3 + " " + s1 + " " + s2;
        }
      }
    }

    function getMake(arr,k){
      return arr[k].substring(0, arr[k].indexOf(",")).trim().replace(/\s+/g,"");
    }

    function getModel(arr,k){
      var Model = arr[k].substring(arr[k].indexOf(",")+1);
      return Model.substring(0, Model.indexOf(",")).trim().replace(/\s+/g,"");
    }

    function handleDetails(ele, str2) {
      ele.previousElementSibling.innerText = str2;
      var str1 = ele.previousElementSibling.previousElementSibling.innerText;
      if(str1.replace(/\s/g,"")){
        str1 = str1.trim().replace(/\s+/g, " ");
        var strArr1 = str1.split(";");
        var modelStr = '<div class="part-fit">\n<h2>Part Fits For</h2>';
        if (strArr1.length > 20) {
          modelStr += '\n<div class="part-fit-radio">';
          for(var i=0; i<strArr1.length; i+=10){
            var mIndex = parseInt(i / 10) + 1;
            modelStr += '\n<input ';
            if(i==0){
              modelStr += 'checked="checked"';
            }
            modelStr += 'id="part-radio'+mIndex+'" class="part-radio" type="radio" name="part-radio">\n<div class="part-tab">\n<ul>';
            for(var j=0; j<10; j++){
              if(strArr1[i+j]){
                modelStr += "\n<li>" + strArr1[i+j].trim() + "</li>";
              }
            }
            modelStr += '\n</ul>\n</div>\n<label for="part-radio' + mIndex+'">'+ mIndex +'</label>';
          }
          modelStr += '\n<label>\n<a href="#vehicle_matching">&gt;&gt;</a>\n</label>\n</div>\n</div>';
        } else {
          modelStr += '\n<ul>';
          for (var i in strArr1) {
            if (strArr1[i].trim().replace(/\s+/g, " ") != "") {
              modelStr += "\n<li>" + strArr1[i].trim() + "</li>";
            }
          }
          modelStr += "\n</ul>\n</div>";
        }
        if(str2.indexOf('<div class="part-fit">')!=-1){
          var pStr1 = str2.substring(0,str2.indexOf("<h2>"));
          var pStr2 = str2.substring(str2.indexOf("</h2>")+5);
          pStr1=pStr1.substring(0,pStr1.indexOf('<div class="part-fit">'));
          pStr2=pStr2.substring(pStr2.indexOf('<h2>'));
          ele.innerText = pStr1 + modelStr + "\n" + pStr2;
        }else{
          var index2 = str2.indexOf("<h2>");
          ele.innerText = str2.substring(0, index2) + modelStr + "\n" + str2.substring(index2);
        }
      }else{
        ele.innerText = ele.previousElementSibling.innerText;
      }
    }
  </script>
</body>

</html>
